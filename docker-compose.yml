services:
  # --- 1. Postgres Database for Airflow Metadata ---
  postgres-db:
    image: postgres:14
    container_name: postgres-db
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - "5432:5432" # So you can connect to it from your laptop if needed

  # --- 2. Airflow Services ---
  airflow-webserver:
    build:
      context: .
      dockerfile: Dockerfile.airflow
    container_name: airflow-webserver
    depends_on:
      - postgres-db
    ports:
      - "8080:8080" # Airflow UI
    env_file:
      - .env
    entrypoint: /entrypoint.sh 
    volumes:                    
      - ./docker/airflow_entrypoint.sh:/entrypoint.sh
      - ./dags:/opt/airflow/dags
      - ./logs:/opt/airflow/logs
    command: webserver # Runs the Airflow UI
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:8080/health"]
      interval: 10s
      timeout: 10s
      retries: 5

  airflow-scheduler:
    build:
      context: .
      dockerfile: Dockerfile.airflow
    container_name: airflow-scheduler
    depends_on:
      - airflow-webserver
    entrypoint: /entrypoint.sh
    volumes:
      - ./docker/airflow_entrypoint.sh:/entrypoint.sh
      - ./dags:/opt/airflow/dags # Mount your local 'dags' folder
      - ./logs:/opt/airflow/logs
    env_file:
      - .env
    command: scheduler # Runs the Airflow scheduler
    # This 'extra_hosts' entry lets the Airflow worker
    # find your laptop's Ollama server
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # --- 3. Vector Database ---
  weaviate:
    image: cr.weaviate.io/semitechnologies/weaviate:latest
    container_name: weaviate
    ports:
      - "8090:8080" # We map to 8090 to avoid conflict with Airflow on 8080
      - "50051:50051" # <-- ADD THIS gRPC PORT
    environment:
      - QUERY_DEFAULTS_LIMIT=25
      - AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED=true
      - DEFAULT_VECTORIZER_MODULE=none # We do embeddings ourselves
      - CLUSTER_HOSTNAME=weaviate
      - PERSISTENCE_DATA_PATH=/var/lib/weaviate
    volumes:
      - weaviate-data:/var/lib/weaviate

  # --- 4. S3 Data Lake ---
  minio:
    image: minio/minio:latest
    container_name: minio
    ports:
      - "9000:9000" # API port
      - "9001:9001" # Web UI port
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    volumes:
      - minio-data:/data
    command: server /data --console-address ":9001"

  # --- 5. RAG API (Your Python Backend) ---
  rag-api:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: rag-api
    ports:
      - "8000:8000" # API port
    env_file:
      - .env
    # This is critical for connecting to host Ollama
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - weaviate

  # --- 6. RAG UI (Your Streamlit App) ---
  rag-ui:
    build:
      context: .
      dockerfile: Dockerfile.ui
    container_name: rag-ui
    ports:
      - "8501:8501" # Streamlit UI port
    env_file:
      - .env
    environment:
      # Ensure this matches the service name above! 
      # If service is 'rag-api', use 'http://rag-api:8000/chat'
      - API_URL=http://rag-api:8000/chat
    depends_on:
      - rag-api

# Define named volumes for persistent data
volumes:
  postgres-data:
  weaviate-data:
  minio-data: